# Developer Notes

### Developer Postulates

These principles guide the development of `pgrwl` to ensure long-term maintainability, ease of use, and operational
clarity:

- **Simplicity**: Prioritize simplicity in both development and usage. The system should be easy to run, understand, and
  extend.
- **Durability**: WAL files must be reliably persisted to prevent data loss - no compromises.
- **Predictability**: The application should behave consistently and transparently across different environments and
  scenarios.

### Developer Experience

- **Simple Configuration**: Users should be able to configure and launch the application with minimal effort - ideally
  with a single YAML file and a few environment variables.
- **Easy Debugging**: Troubleshooting should not require navigating complex dependencies. The system must produce
  helpful, traceable logs.

### Clarity of Purpose

- Anyone should be able to:
    - Understand what the application does.
    - Use it confidently without prior deep knowledge of PostgreSQL internals.
    - Contribute to it without needing to reverse-engineer its design.

### Observability

- **Structured Logging**: All logs use structured formats (e.g., JSON or text with context) and support verbose tracing
  when needed.
- **Metrics**: Prometheus-compatible metrics are exposed for observability, health checks, and integration with
  monitoring dashboards.

### Integration Testing

Here an example of a [golden fundamental test](test/integration/environ/scripts/tests/001-fundamental.sh).
It verifies that we can restore to the latest committed transaction after an abrupt system crash.
It also checks that the WAL files generated are byte-for-byte identical to those generated by `pg_receivewal`.

#### Test Steps:

- Initialize and start a PostgreSQL cluster
- Run WAL receivers (`pgrwl` and `pg_receivewal`)
- Create a base backup
- Create a table, and insert the current timestamp every second (in the background)
- Run pgbench to populate the database with 1 million rows
- Generate additional data (~512 MiB)
- Concurrently create 100 tables with 10000 rows each.
- Terminate the insert-script job
- Run pg_dumpall and save the output as plain SQL
- Terminate all PostgreSQL processes and delete the `PGDATA` directory (termination is force and abnormal)
- Restore `PGDATA` from the base backup, add recovery.signal, and configure restore_command
- Rename all `*.partial` WAL files in the WAL archive directories
- Start the PostgreSQL cluster (cluster should recover to the latest committed transaction)
- Run pg_dumpall after the cluster is ready
- Diff the pg_dumpall results (before and after)
- Check the insert-script logs and verify that the table contains the last inserted row
- Compare WAL directories (filenames and contents must match 100%)
- Clean up WAL directories and rerun the WAL archivers on a new timeline (cleanup is necessary since we run receivers
  with --no-loop option)
- Compare the WAL directories again

### To contribute or verify the project locally, the following `make` targets should all pass:

```bash
# Compile the project
make build

# Run linter (should pass without errors)
make lint

# Run unit tests (should all pass)
make test

# Run integration tests (slow, but critical)
# Requires Docker and Docker Compose to be installed
make test-integ-scripts

# Run GoReleaser builds locally
make snapshot
```

✅ All targets should complete successfully before submitting changes or opening a PR.

### Source Code Structure

```
internal/core/xlog/pg_receivewal.go
  → Entry point for WAL receiving logic.
    Based on the logic found in PostgreSQL:
    https://github.com/postgres/postgres/blob/master/src/bin/pg_basebackup/pg_receivewal.c

internal/core/xlog/receivelog.go
  → Core streaming loop and replication logic.
    Based on the logic found in PostgreSQL:
    https://github.com/postgres/postgres/blob/master/src/bin/pg_basebackup/receivelog.c

internal/core/xlog/xlog_internal.go
  → Helpers for LSN math, WAL file naming, segment calculations.
    Based on the logic found in PostgreSQL:
    https://github.com/postgres/postgres/blob/master/src/include/access/xlog_internal.h

internal/core/xlog/walfile.go
  → Manages WAL file descriptors: open, write, close, sync.

internal/core/xlog/streamutil.go
  → Utilities for querying server parameters (e.g. wal_segment_size),
    replication slot info, and streaming setup.

internal/core/xlog/fsync/
  → Optimized wrappers for safe and efficient `fsync` system calls.
```

```
internal/opt/basebackup
  → Streaming basebackup components
  
internal/opt/httpsrv
  → An HTTP server for serve/receive modes
  
internal/opt/supervisor
  → Components such as: uploader, renainer  
```
