name: Integration Tests (weekly)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0"

env:
  CACHE_FOLDER: docker-cache
  CACHE_FILE_DOCKER_SSHD: docker-cache/docker_sshd.tgz
  CACHE_FILE_DOCKER_PG_PRIMARY: docker-cache/docker_pg_primary.tgz
  CACHE_FILE_DOCKER_PG_STANDBY: docker-cache/docker_pg_standby.tgz
  CACHE_FILE_DOCKER_MINIO: docker-cache/docker_minio.tgz
  CACHE_FILE_DOCKER_MINIO_MC: docker-cache/docker_minio_mc.tgz
  COMPOSE_FILE: "test/integration/environ/docker-compose.yml"

jobs:
  build_images:
    name: Build images (pg${{ matrix.pg_major }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        pg_major: [17, 18]

    env:
      PG_MAJOR: ${{ matrix.pg_major }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Compute image cache key
        id: cache-key
        run: |
          # IMPORTANT: only hash *inputs* to image build, NOT docker-cache or binaries
          KEY="docker-images-pg${{ matrix.pg_major }}-${{ hashFiles(
            'go.mod',
            'test/integration/environ/docker-compose.yml',
            'test/integration/environ/dockerfiles/**',
            'test/integration/environ/files/**',
            'test/integration/environ/scripts/**',
            '.github/workflows/integration.yml'
          ) }}"
          echo "value=${KEY}" >> "$GITHUB_OUTPUT"

      - name: Restore Docker image cache
        id: cache-images
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CACHE_FILE_DOCKER_PG_PRIMARY }}
            ${{ env.CACHE_FILE_DOCKER_PG_STANDBY }}
            ${{ env.CACHE_FILE_DOCKER_SSHD }}
            ${{ env.CACHE_FILE_DOCKER_MINIO }}
            ${{ env.CACHE_FILE_DOCKER_MINIO_MC }}
          key: ${{ steps.cache-key.outputs.value }}

      - name: Load images from cache (if present)
        if: steps.cache-images.outputs.cache-hit == 'true'
        run: |
          set -euo pipefail

          echo "Restored cached image archives, loading into Docker..."
          ls -lah "${{ env.CACHE_FOLDER }}" || true

          printf '%s\n' \
            "${CACHE_FILE_DOCKER_PG_PRIMARY}" \
            "${CACHE_FILE_DOCKER_PG_STANDBY}" \
            "${CACHE_FILE_DOCKER_SSHD}" \
            "${CACHE_FILE_DOCKER_MINIO}" \
            "${CACHE_FILE_DOCKER_MINIO_MC}" \
          | xargs -n1 -P4 bash -c '
            set -euo pipefail
            f="$0"
            [ -f "$f" ] || { echo "Skip missing $f"; exit 0; }
            echo "Loading image from $f ..."
            gunzip -c "$f" | docker load
          '

          echo "Images after load (if any):"
          docker images || true

      - name: Set up Go
        if: steps.cache-images.outputs.cache-hit != 'true'
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Prepare Binary
        if: steps.cache-images.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          make build
          mv bin test/integration/environ

      - name: Build Docker images and cache them
        if: steps.cache-images.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail

          echo "Building images for PG_MAJOR=${PG_MAJOR} from scratch (no cache hit)..."
          docker compose -f "${{ env.COMPOSE_FILE }}" build pg-primary pg-standby sshd minio createbuckets

          echo "=== Images after build ==="
          docker images || true

          mkdir -p "${{ env.CACHE_FOLDER }}"

          # Save all images concurrently (image -> cache file)
          printf '%s %s\n' \
            "pgrwl/pg-primary-${PG_MAJOR}" "${CACHE_FILE_DOCKER_PG_PRIMARY}" \
            "pgrwl/pg-standby-${PG_MAJOR}" "${CACHE_FILE_DOCKER_PG_STANDBY}" \
            "pgrwl/sshd"                    "${CACHE_FILE_DOCKER_SSHD}" \
            "pgrwl/minio"                   "${CACHE_FILE_DOCKER_MINIO}" \
            "pgrwl/minio-mc"                "${CACHE_FILE_DOCKER_MINIO_MC}" \
          | xargs -n2 -P4 bash -c '
              set -euo pipefail
              img="$1"
              out="$2"
              echo "Saving ${img} -> ${out} ..."
              docker save "${img}" | gzip -c > "${out}"
              echo "Saved ${img}"
            ' _

          echo "=== Cached archives ==="
          ls -lah "${{ env.CACHE_FOLDER }}"

  test:
    name: Run integration tests (pg${{ matrix.pg_major }})
    runs-on: ubuntu-latest
    needs: [build_images]

    strategy:
      fail-fast: false
      matrix:
        pg_major: [17, 18]

    env:
      PG_MAJOR: ${{ matrix.pg_major }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Compute image cache key
        id: cache-key
        run: |
          KEY="docker-images-pg${{ matrix.pg_major }}-${{ hashFiles(
            'go.mod',
            'test/integration/environ/docker-compose.yml',
            'test/integration/environ/dockerfiles/**',
            'test/integration/environ/files/**',
            'test/integration/environ/scripts/**',
            '.github/workflows/integration.yml'
          ) }}"
          echo "value=${KEY}" >> "$GITHUB_OUTPUT"

      - name: Restore Docker image cache
        id: cache-images
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.CACHE_FILE_DOCKER_PG_PRIMARY }}
            ${{ env.CACHE_FILE_DOCKER_PG_STANDBY }}
            ${{ env.CACHE_FILE_DOCKER_SSHD }}
            ${{ env.CACHE_FILE_DOCKER_MINIO }}
            ${{ env.CACHE_FILE_DOCKER_MINIO_MC }}
          key: ${{ steps.cache-key.outputs.value }}

      - name: Fail if cache is missing
        if: steps.cache-images.outputs.cache-hit != 'true'
        run: |
          echo "Docker image cache not found for PG_MAJOR=${PG_MAJOR}!"
          exit 1

      - name: Load Docker images from cache
        run: |
          set -euo pipefail

          ls -lah "${{ env.CACHE_FOLDER }}" || true

          gunzip -c "${{ env.CACHE_FILE_DOCKER_PG_PRIMARY }}" | docker load
          gunzip -c "${{ env.CACHE_FILE_DOCKER_PG_STANDBY }}" | docker load
          gunzip -c "${{ env.CACHE_FILE_DOCKER_SSHD }}" | docker load
          gunzip -c "${{ env.CACHE_FILE_DOCKER_MINIO }}" | docker load
          gunzip -c "${{ env.CACHE_FILE_DOCKER_MINIO_MC }}" | docker load

          echo "=== Images after load ==="
          docker images || true

      - name: Run tests
        run: |
          set -euo pipefail

          echo "Running integration tests against PostgreSQL ${PG_MAJOR}"
          docker images || true

          docker compose -f "${{ env.COMPOSE_FILE }}" up -d
          docker ps

          docker compose -f "${{ env.COMPOSE_FILE }}" exec -T pg-primary chmod +x /var/lib/postgresql/scripts/runners/run-tests.sh
          docker compose -f "${{ env.COMPOSE_FILE }}" exec -T pg-primary \
            env PG_MAJOR="${PG_MAJOR}" \
            su - postgres -c /var/lib/postgresql/scripts/runners/run-tests.sh
